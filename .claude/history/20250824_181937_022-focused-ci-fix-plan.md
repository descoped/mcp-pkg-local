# Focused CI Fix Plan - Do It Right This Time

**Date**: 2025-08-24  
**Objective**: Fix ONLY the CI pipeline failures without contaminating the architecture  
**Approach**: Surgical precision - NO random fixes, NO agent sprawl, NO workarounds  

## Current Situation

- **Local Tests**: ✅ 100% passing (before b6b43b8)
- **CI Tests**: ❌ Failed due to environment differences
- **Root Cause**: Tests made invalid assumptions, NOT architecture problems
- **Last Clean Commit**: One commit before b6b43b8

## The ONLY Problems to Fix

Based on the CI failures, there are exactly **THREE** root causes:

### Problem 1: UV Version Incompatibility
**CI has UV 0.5.0, Local has UV 0.8.11**
- The `--no-header` flag doesn't exist in UV 0.5.0
- **Fix**: Remove the flag or detect version before using it
- **File**: `src/bottles/package-managers/uv.ts`
- **Lines**: Where `--no-header` is used in pip list command

### Problem 2: JSON Output Contains Progress Indicators
**Package managers output progress that breaks JSON.parse()**
- UV and pip output ANSI codes and progress bars
- **Fix**: Always set clean output environment variables
- **File**: `src/bottles/package-managers/uv.ts` 
- **Action**: Set `UV_NO_PROGRESS=1`, `NO_COLOR=1` for ALL commands, not conditionally

### Problem 3: Tests Assume Instant Operations
**Tests fail when operations take time in CI**
- Shell recovery after timeout needs proper wait
- **Fix**: Add ONE utility function for state waiting
- **File**: Create `tests/bottles/test-utils/wait-helpers.ts`
- **Implementation**: 
  ```typescript
  export async function waitForCondition(
    condition: () => boolean | Promise<boolean>,
    timeoutMs = 5000,
    intervalMs = 100
  ): Promise<void> {
    const start = Date.now();
    while (Date.now() - start < timeoutMs) {
      if (await condition()) return;
      await new Promise(r => setTimeout(r, intervalMs));
    }
    throw new Error('Timeout waiting for condition');
  }
  ```

## Step-by-Step Execution Plan

### Step 1: Revert to Clean State
```bash
# Create branch from last known good state
git checkout -b fix/ci-properly b6b43b8~1

# Verify local tests still pass
npm test
```

### Step 2: Fix UV Version Compatibility (10 minutes)

**File**: `src/bottles/package-managers/uv.ts`

**Find** the `listPackages` method around line 520:
```typescript
// BEFORE
const args = [
  'pip', 'list',
  '--format', 'json',
  '--no-color',
  '--quiet',
  '--no-header'  // <-- REMOVE THIS
];
```

**Change to**:
```typescript
// AFTER
const args = [
  'pip', 'list',
  '--format', 'json',
  '--no-color',
  '--quiet'
  // Removed --no-header for UV 0.5.0 compatibility
];
```

### Step 3: Fix Output Contamination (10 minutes)

**File**: `src/bottles/package-managers/uv.ts`

**Find** the `getEnvironmentVariables` method:
```typescript
// BEFORE - might not have these set
protected getEnvironmentVariables(options?: CommandOptions): Record<string, string> {
  return {
    ...options?.env
  };
}
```

**Change to**:
```typescript
// AFTER - always ensure clean output
protected getEnvironmentVariables(options?: CommandOptions): Record<string, string> {
  return {
    UV_NO_PROGRESS: '1',
    UV_NO_COLOR: '1', 
    NO_COLOR: '1',
    FORCE_COLOR: '0',
    ...options?.env
  };
}
```

**Also add to** `src/bottles/package-managers/pip.ts`:
```typescript
protected getEnvironmentVariables(options?: CommandOptions): Record<string, string> {
  return {
    NO_COLOR: '1',
    PIP_NO_COLOR: '1',
    PIP_PROGRESS_BAR: 'off',
    FORCE_COLOR: '0',
    ...options?.env
  };
}
```

### Step 4: Fix Test Timing Assumptions (15 minutes)

**Create**: `tests/bottles/test-utils/wait-helpers.ts`
```typescript
/**
 * Wait for a condition without arbitrary timeouts
 */
export async function waitForCondition(
  condition: () => boolean | Promise<boolean>,
  timeoutMs = 5000,
  intervalMs = 100,
  message = 'Condition not met'
): Promise<void> {
  const start = Date.now();
  while (Date.now() - start < timeoutMs) {
    if (await condition()) return;
    await new Promise(r => setTimeout(r, intervalMs));
  }
  throw new Error(`Timeout: ${message}`);
}

/**
 * Parse potentially contaminated package manager output
 */
export function extractJSON(output: string): any {
  // Remove ANSI escape codes
  const cleaned = output.replace(/\x1b\[[0-9;]*m/g, '');
  
  // Find JSON in the output
  const jsonMatch = cleaned.match(/\[[\s\S]*\]|\{[\s\S]*\}/);
  if (!jsonMatch) {
    return null;
  }
  
  try {
    return JSON.parse(jsonMatch[0]);
  } catch {
    return null;
  }
}
```

**Fix** the Shell-RPC recovery test in `tests/bottles/unit/shell-rpc.test.ts`:
```typescript
// Line ~48: Fix the recovery test
it('should recover after timeout', async () => {
  shell = new ShellRPC({ defaultTimeout: 1000 });
  await shell.initialize();
  
  // Command that will timeout
  const timeoutResult = await shell.execute('cat', 100);
  expect(timeoutResult.timedOut).toBe(true);
  
  // Wait for shell to be ready (not arbitrary time!)
  await waitForCondition(
    () => shell.getStatus().alive,
    5000,
    100,
    'Shell should be alive after timeout'
  );
  
  // Now test recovery - no conditional timeouts!
  const result = await shell.execute('echo "recovered"', 2000);
  expect(result.stdout).toContain('recovered');
  expect(result.exitCode).toBe(0);
});
```

### Step 5: Test and Commit

```bash
# Test locally first
npm test

# Commit with clear message
git add -A
git commit -m "fix: minimal CI compatibility fixes without workarounds

- Remove --no-header flag for UV 0.5.0 compatibility  
- Always set clean output environment variables
- Add proper wait condition helper for async tests
- No environment-specific code paths added"

# Push and watch CI
git push origin fix/ci-properly
```

## What NOT to Do

### ❌ DO NOT:
1. Add any `if (process.env.CI)` conditionals
2. Skip any tests
3. Change timeout multipliers
4. Add debug logging
5. Create different code paths for CI vs local
6. Modify CI workflow yaml files
7. Add workarounds for "flaky" tests
8. Let agents make decisions without specific instructions

### ✅ DO ONLY:
1. Remove incompatible UV flags
2. Set clean output environment variables
3. Add ONE wait helper function
4. Fix specific test timing assumptions
5. Test locally before pushing

## Success Criteria

- **All tests pass in CI** without any environment-specific code
- **No new code paths** for CI vs local  
- **Less than 50 lines changed** total
- **No architecture contamination**
- **CI config remains simple** (<100 lines)

## If This Doesn't Work

If after these minimal fixes CI still fails:
1. **Check the actual CI error** - not what we think it is
2. **Fix ONLY that specific error** - not related issues
3. **Do not spawn agents** - handle it directly
4. **Document the specific fix** - not general improvements

## Key Principle

**The architecture is correct. The tests made wrong assumptions. Fix ONLY the assumptions, nothing else.**

This plan should take less than 1 hour to implement and will result in a clean, maintainable solution without technical debt.